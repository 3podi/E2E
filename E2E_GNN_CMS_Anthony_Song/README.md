<div align="center">

  # Graph Neural Networks for End-to-End Particle Identification with the CMS Experiment

<a href="https://gist.github.com/eraraya-ricardo/8391f6bdae596e82fe0260c215c5ab8c" target="_blank"><img src="https://img.shields.io/badge/Google%20Summer%20of%20Code-2023-fbbc05?style=flat&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAALVBMVEVHcEz7vQD7vQD8vQD7vQD8vQD7vQD8vQD8vQD7vQD7vQD8vQD7vQD7vQD7vQAgxtLpAAAADnRSTlMAZvVQ6QrVPhl6oSmHvzL6LQUAAASGSURBVHjatdnZdusgDAVQELMY%2Fv9zb2%2Bwc%2BIKDzQLvTXB3gYBFqmaDVeKU4sCBlFyy43WqLjlBpR1BpR1BpR1xjoFxmIFBpSVBpSVBpSVBpSVBpQ1xvdK1oPgblhfOWltjNaJq7ddYT2IfImYJqMDrENUChGDZn%2FWQ%2FMHxBcD4BMyBc5XCHkNQTq60vfIgXAx5xByju6T8V8itsT3%2FUPi6r39Ce8rp%2FCWYrHfIDXs95FZJs%2FvTob6Z4T2buQE4eikvHeG%2FoZY7TpRfDsNWzrjtP0L4s12NYhh%2BO1ZjJ9HfOjdYGo3QZx7YvwEAgOPdx3eQJlArMFA3wXSZ%2BwMQvplJGoPY6sqNU0gxcGYUVx5jtSIx3oS6HysTxEbMMDPAmkM9iFSXnPXt8nwuQ%2FYI8TH%2F425TQe7%2FnBPEH2bECI6T4t%2Bgvh4N1istR50FJdeIX1Ek%2FqJdGGQOWmAa4u7rn18vuuIzUq52gbxvpiSuzIau%2BuO9FUUfTvvCjcoQ4MMltRnEOqF0pdD%2FwiBZWxoqGCn8r2VGKIUCHOoTyHK2g7y1bsJRRqNe3%2FlXv5GbNhWEWXxbsf1UITRF4kYcM4KiI%2FbeFIevNNq7P2EIg0bVL%2BfqCcyYV2rbDdExWSPjUPPGBRh9JTowTscW0Dqf%2BwLXGmPthgKKMJo1f1OSQ29hf1Mbdlmg5NFV1H7KoICA3mruIQ4vl4TTFhvuAlxxrdb1J55KMJoBatEPCv6mr3sJzK%2F9RQKDAx49Ji5ctSLwsxAxgyuiduOAeVtIG14zppPKtAka9lcMZz71IHyNoAcCpvIx6UfxGLleCim3ggUpe0dQhe7I86mWvQERZmCIocryAqPsdYOSQlVIjCgyMRbLSaXxi3GD4LEw4AipzCyyvS5a5ThMpJTGAYUuQljhiWL53R11FN5BxhQsK0UWbE747E7evGV2FaEAUWmDave0H4LQxg6nErl1IEBBRdmOzjkBPpdqFB%2BpUtUGb0tDKloZP44hQLthQoDwXYiXlowpMJIymExdARL8SViYzymhGEMFR%2FR3cOyNoRCpQcZFu1s6AsNhlQuSiJP%2B1Kk90dNRHW9BYyhwlszhNgdb05CjmGcKDb3DotAoYIYV9wWxjDSZcHNmN%2Fj0KpPm3R7dMjq7HlrSokvjIqjww3SEhb4XJDpg3CLvM9%2BPG%2FMHOcaOwzYRFScNe8QHJb9nOEDhvkGwV48eZC3BgfzWwSHZaXthKEVMvkMaQnKhKESzSCkJ37uQqlJ7RmCIcbr%2By5qUEjiIwQK3q4yZKHqYDxEUIo4U6%2BNahxKr0kEZwv8HC%2BDqo69UaI2ieBAujN2RNhOoPybQjBr9oNSKNXSoQ%2B2luCUQuk1iSCIg9oiZl24Vv8TtXLROaotAtO3%2F9ooWSFcjDnH6BQio2SZQSRz%2FpsPfsifQ2RY1tmNBM3oxQRCbRjkOZn%2FEACT2J%2B1vkZiGESyG1SZS%2FqJ1wTogE1hEFHNh9yNCbvvREwqCwwoawwoKw0oKw0oKw0oKw0oKw0oKw0oMFYqMFYqMFYqMBYq88Y%2FxB7wiOJRvWkAAAAASUVORK5CYII%3D" /></a>

[![Open Source Love](https://firstcontributions.github.io/open-source-badges/badges/open-source-v2/open-source.svg)](https://github.com/firstcontributions/open-source-badges)

**A Google Summer of Code 2023 Project Repository.**<br>The main purpose of this project is to explore the use of Graph Neural Netowrks (GNNs) in the domain of particle physics. The associated detailed blog post for this project can be found [here](https://medium.com/@anthony_iytrzx/test-title-gsoc-2023-92732bff3e57).<br>

  <a href="https://ml4sci.org/" target="_blank"><img alt="gsoc@ml4sci" height="200px" src="https://raw.githubusercontent.com/eraraya-ricardo/qcnn-hep/main/assets/gsoc%40ml4sci.jpeg" /></a>

</div>

***
## Table of Content
- [Introduction](#introduction)
- [Setup](#setup)
- [Data](#data)
- [How to run the codes](#how-to-run-the-codes)
- [Configuration](#configuration)
- [Structure of the Repository](#structure-of-the-repository)
- [Acknowledgement](#acknowledgement)
- [References](#references)

## Introduction
This project focuses on developing and evaluating end-to-end Graph Neural Network (GNN) models for low-momentum tau identification and mass reconstruction in the context of particle physics experiments, such as the Compact Muon Solenoid (CMS) at CERN. Previously there have been attempts to classify the jet images with ResNet-based architectures. In our case we aim to improve tau identification and mass reconstruction performance by leveraging GNNs' ability to capture complex relationships between jet constituents. Additionally, this project will test GNN inference on Graphics Processing Units (GPUs) to assess the potential for real-time analysis and integration with existing systems. We test the models across two different datasets namely the Top Gun dataset for particle reconstruction and the Quark-Gluon dataset for particle identification.

## Setup

If at least one GPU is available. Install all the required packages via the following command. The provided environment is built on CUDA Toolkit 11.3.
```bash
pip install -r requirements_gpu.txt
```

If no GPU is available. Install all the required packages via the following command.
```bash
pip install -r requirements.txt
```

## Data

We use two datasets for this project. One is the Top Gun dataset for particle reconstruction (mass reconstruction) and the other one is he Quark-Gluon dataset[[1]](#1) for particle identification (tau identification).

### Top Gun dataset
To download the Top Gun dataset, run the followling line. The downloaded files are in the Apache Parquet format. Note that the downloaded files should be placed under the ```data/top_gun/raw``` directory.
```bash
wget https://cernbox.cern.ch/index.php/s/cmVxUG4GJzRWKWV/download
```

### Quark-Gluon dataset
To download the Quark-Gluon dataset, run the followling line. The downloaded files are in the Apache Parquet format. Note that the downloaded files should be placed under the ```data/quark_gluon/raw``` directory.
```bash
wget https://cernbox.cern.ch/index.php/s/ZUHveJKajnZNwTA/download
```

## How to run the codes

The excution of the codes is simple. Simplely run the following line. All the configurations are set up in the provided json files.
```bash
python train.py -c path/to/configuration/file
```

Changing values of config file is a clean, safe and easy way of tuning hyperparameters. However, sometimes it is better to have command line options if some values need to be changed too often or quickly. We can also change some of them using CLI flags.

```bash
python train.py -c path/to/configuration/file --bs 256
```

This line runs training with options given in the provided json file except for the `batch size` which is changed to 256 by command line options.

### Train the top gun dataset with GPU

```bash
python train.py -c configs/config_gpu.json
```

### Train the top gun dataset without GPU

```bash
python train.py -c configs/config.json
```

### Train the Quark-Gluon dataset with GPU

```bash
python train.py -c configs/config_qg.json
```

## Configuration

All the config files are in `.json` format. We use the following as an example.

```javascript
{   
    "name": "graph_regression",         // training session name
    "n_gpu": 1,                         // number of GPUs to use for training.

    "arch": {                           // name of model architecture to train
        "type": "GNNModel",
        "args": {}
    },

    "preprocessor":{                    // selecting data preprocessor
        "type": "TopGunPreprocessor",
        "args":{
            "use": true,                // whether to use the existing processed data
            "data_dir": "data/top_gun", // data path
            "num_files":7,              // num of raw files
            "test_ratio":0.2,           // test data ratio
            "val_ratio":0.2,            // val data ratio
            "transform_flags":{
                "LapPE": false,                                                       
                "LapPEnorm": "sym",                                                                            
                "LapPEmax_freq": 10,                                                                           
                "LapPEeig_norm": "L2",                                                                         
                "RWSE": false,          
                "RWSEkernel_times": [2, 3, 5, 7, 10]
            },
            "mode": "regression",
            "scale_histogram":true,
            "predict_bins":false,
            "min_mass":0.0,
            "max_mass":1.0,
            "num_bins":10,
            "point_fn":"total",
            "use_pe":false,
            "num_pe_scales":10,
            "min_threshold":1e-3,
            "output_mean_scaling":false,
            "output_mean_value":293.2899,
            "output_norm_scaling":false,
            "output_norm_value":119.904,
            "construction": "knn",    // graph construction method
            "k": 20                   // hyparameters in the kNN graph construction method
        }
    },

    "data_loader": {                    // selecting data loader
        "type": "TopGunDataLoader",     
        "args":{
            "data_dir": "data/top_gun/",
            "batch_size": 128,          // batch size
            "shuffle": true,            // shuffle training data before splitting
            "validation_split": 0.2,    // size of validation dataset. float(portion) or int(number of samples)
            "num_workers": 2,           // number of workers
            "train_batch_size": 16,     // train batch size
            "val_batch_size": 16,       // val batch size
            "test_batch_size": 16,      // test batch size
            "multi_gpu": false
        }
    },

    "model_loader":{                    // selecting the training model
        "type":"GNNModelLoader",
        "args":{
            "device":"cuda",          
            "model":"gps",
            "edge_feat":"R",
            "point_fn": "total",
            "multi_gpu": false,
            "mode": "regression",
            "pretrained": false,
            "use_pe": false,
            "num_pe_scales": 10,  
            "predict_bins":false,
            "num_bins":10,
            "LapPE": false,                                                       
            "LapPEnorm": "sym",                                                                            
            "LapPEmax_freq": 10,                                                                           
            "LapPEeig_norm": "L2",                                                                         
            "RWSE": false,          
            "RWSEkernel_times": [2, 3, 5, 7, 10],
            "gps_mpnn_type": "gatedgcn",                                                                         
            "gps_global_type": "performer",                                                                     
            "gps_num_heads": 4,                                                                            
            "gps_dim_h":128,                                                                               
            "num_gps_layers": 5
        }
    },

    "optimizer": {                      // selecting training optimizer
        "type": "Adam",
        "args":{
            "lr": 0.001,                
            "weight_decay": 0,
            "amsgrad": true
        }
    },

    "loss_loader": {                    // selecting the training loss
        "type": "LossLoader",
        "args":{
            "criterion_type":"mse",
            "criterion_beta": 20,
            "predict_bins":false
        }
    },

    "metric_loader": {                  // selecting the metrics
        "type": "MetricLoader",
        "args":{
        }
    },

    "metrics": [
        "accuracy", "top_k_acc"
    ],

    "optimizer_loader":{
        "type": "OptimizerLoader",
        "args":{
            "optim":"adamw",
            "lr": 5e-4,
            "sched_type": "ca_wm",                                                                            
            "lr_step": 5,                                                                                  
            "lr_gamma": 0.1,
            "min_lr": 1e-7,                                                                                
            "T_0": 5
        }
    },

    "lr_scheduler": {                   // selecting the learning rate
        "type": "StepLR",
        "args": {                       // learning rate scheduler
            "step_size": 50,
            "gamma": 0.1
        }
    },

    "trainer": {
        "type": "GNNTrainer",
        "args":{
            "num_epochs": 50,           // number of training epochs
            "mode": "regression",
            "train_batch_size": 16, 
            "val_batch_size": 16,
            "device": "cuda", 
            "multi_gpu": false,                                                                      
            "output_mean_scaling": false,                                                    
            "output_mean_value": 293.2899,                                                                 
            "output_norm_scaling": false,                                                    
            "output_norm_value": 119.904,                                                                                                                                           
            "scale_histogram": true,                                                        
            "predict_bins": false,                                                                                                                                    
            "debug": false
        },
        "epochs": 50,
        "save_dir": "saved/",           // checkpoints are saved in save_dir  
        "save_period": 1,               // save checkpoints every save_freq epochs
        "verbosity": 2,                 // 0: quiet, 1: per epoch, 2: full
        "monitor": "min val_loss",      // mode and metric for model performance monitoring. set 'off' to disable.
        "early_stop": 10,               // number of epochs to wait before early stop. set 0 to disable.
        "tensorboard": true
    },

    "num_epochs": 50,                                                                               
    "device": "cuda",                                                                                                                                                        
    "save_path": "./ckpt",                                                                         
    "data_dir": "data/top_gun",             
    "train_batch_size": 16,                                                                        
    "val_batch_size": 16,                                                                          
    "test_batch_size": 16,                                                                         
    "num_files": 7,                                                                                
    "val_ratio": 0.2,                                                                              
    "test_ratio": 0.2,                                                                             
    "pretrained": false,                                                             
    "lr": 5e-4,                                                                            
    "lr_step": 5,                                                                                  
    "lr_gamma": 0.1,                                                                               
    "criterion_type": "mse",                                                                       
    "criterion_beta": 20,                                                                          
    "use_pe": false,                                                                 
    "num_pe_scales": 10,                                                                            
    "min_threshold": 1e-3,                                                                        
    "output_mean_scaling": false,                                                    
    "output_mean_value": 293.2899,                                                                 
    "output_norm_scaling": false,                                                   
    "output_norm_value": 119.904,                                                                 
    "model": "gps",                                                                               
    "point_fn": "total",                                                                          
    "plot": false,                                                                  
    "edge_feat": "R",                                                                           
    "scale_histogram": true,                                                        
    "predict_bins": false,                                                        
    "min_mass": 0.0,                                                                               
    "max_mass": 1.0,                                                                               
    "num_bins": 10,                                                                                
    "debug": false,
    "sched_type": "ca_wm",                                                                           
    "min_lr": 1e-7,                                                                                
    "T_0": 5,                                                                                      
    "optim": "adamw",                                                                              
    "LapPE": false,                                                       
    "LapPEnorm": "sym",                                                                            
    "LapPEmax_freq": 10,                                                                           
    "LapPEeig_norm": "L2",                                                                         
    "RWSE": false,                                                                                                   
    "save_data": false,                                                        
    "gps_mpnn_type": "gatedgcn",                                                                         
    "gps_global_type": "performer",                                                                     
    "gps_num_heads": 4,                                                                            
    "gps_dim_h":128,                                                                               
    "num_gps_layers": 5,                                                                           
    "multi_gpu": false
}
```

## Structure of the Repository

```
  GNN_CMS/
  │
  ├── train.py - main script to start training
  ├── test.py - evaluation of trained model
  │
  ├── parse_config.py - class to handle config file and cli options
  ├── configs/ - store configuration files
  │   ├── config.json - holds configuration for training the top gun dataset without GPUs
  │   ├── config_gpu.json - holds configuration for training the top gun dataset with GPUs
  │   └── ... - other configuration files
  │
  ├── base/ - abstract base classes
  │   ├── base_data_loader.py
  │   ├── base_model.py
  │   └── base_trainer.py
  │
  ├── data_loader/ - anything about data loading goes here
  │   └── data_loaders.py
  │
  ├── data/ - default directory for storing input data
  │   ├── quark_gluon
  │   │   ├── raw - store raw files of the quark gluon dataset
  │   │   │   └── ...
  │   │   └── processed - store processed files of the quark gluon dataset
  │   │       └── ...         
  │   └── top_gun
  │       ├── raw - store raw files of the top gun dataset
  │       │   └── ...
  │       └── processed - store processed files of the top gun dataset
  │           └── ...    
  │
  ├── models/ - models, losses, and metrics
  │   ├── model.py
  │   ├── metric.py
  │   ├── loss.py
  │   └── ...
  │
  ├── saved/
  │   ├── models/ - trained models are saved here
  │   └── log/ - default logdir for tensorboard and logging output
  │
  ├── preprocessor/ - preprocessing of the raw data
  │   ├── point_cloud_dataset.py - construct the point cloud data from the jet images
  │   └── preprocessor.py - preprocess procedure of the raw data
  │
  ├── trainer/ - trainers
  │   ├── gnn_trainer.py - train the GNNs model
  │   └── trainer.py - train the base model
  │
  ├── logger/ - module for tensorboard visualization and logging
  │   ├── visualization.py
  │   ├── logger.py
  │   └── logger_config.json
  │  
  └── utils/ - small utility functions
      ├── util.py - other utility functions
      ├── dataset_utils.py - dataset-related utility functions
      ├── model_utils.py - model-related utility functions
      └── train_utils.py - training-related utility functions
```

## Acknowledgement

Thanks to Dr. Sergei Gleyzer for his guidance during the project and the huge support from the ML4SCI community, including but not limited to Bhim Bam, Colin Crovella and Ruchi Chudasama. Besides, the project template is built based on [[2]](#2) and some parts of the code are developed based on [[3]](#3).

## References
<a id="1">[1]</a> Andrews, M., Alison, J., An, S., Burkle, B., Gleyzer, S., Narain, M., ... & Usai, E. (2020). End-to-end jet classification of quarks and gluons with the CMS Open Data. Nuclear instruments and methods in physics research section A: accelerators, spectrometers, detectors and associated equipment, 977, 164304.

<a id="2">[2]</a> https://github.com/victoresque/pytorch-template

<a id="3">[3]</a> https://summerofcode.withgoogle.com/programs/2022/projects/MB5Hx1cQ

